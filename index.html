<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChatP2P">
    <title>ChatP2P - Privado y Seguro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            -webkit-user-callout: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #fff;
            overflow: hidden;
            position: fixed;
            -webkit-touch-callout: none;
        }

        /* Prevenir capturas de pantalla */
        body {
            -webkit-user-select: none;
            user-select: none;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #000000;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .screen.active {
            display: flex;
        }

        /* HOME SCREEN */
        .home-header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            border-bottom: 2px solid #FFD700;
            padding: 2rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .home-title {
            font-size: 2rem;
            font-weight: 800;
            color: #FFD700;
            letter-spacing: 1px;
        }

        .home-header-right {
            display: flex;
            gap: 0.75rem;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-item {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid #FFD700;
            border-radius: 16px;
            padding: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-item:active {
            background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
            color: #000;
            transform: scale(0.98);
        }

        .chat-item:active .chat-name,
        .chat-item:active .chat-preview {
            color: #000;
        }

        .chat-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 0.5rem;
        }

        .chat-preview {
            font-size: 0.9rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .message-status {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 0.5rem;
        }

        .empty-chats {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            opacity: 0.7;
        }

        .icon-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
            border: none;
            color: #000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .icon-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        /* USER PROFILE SCREEN */
        .profile-screen {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .profile-header {
            text-align: center;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 1.5rem;
        }

        .profile-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .profile-title {
            font-size: 1.5rem;
            color: #FFD700;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .profile-info {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 12px;
            padding: 1rem;
            font-size: 0.9rem;
            word-break: break-all;
            color: #fff;
            margin-bottom: 1rem;
        }

        .profile-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .profile-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
            border: none;
            color: #000;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .profile-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .profile-btn.secondary {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
            color: #FFD700;
        }

        .profile-btn.danger {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #FF0000;
            color: #FF0000;
        }

        /* CHAT SCREEN */
        .chat-header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            border-bottom: 2px solid #FFD700;
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .back-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
            border: none;
            color: #000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .back-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .chat-header-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: #FFD700;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 1rem;
            border-radius: 18px;
            word-wrap: break-word;
            font-size: 1rem;
            line-height: 1.5;
        }

        .message.other .message-bubble {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 2px solid #FFD700;
            color: #fff;
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
            color: #000;
            font-weight: 700;
        }

        .message img, .message video {
            max-width: 250px;
            border-radius: 16px;
            border: 2px solid #FFD700;
        }

        .input-area {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            border-top: 2px solid #FFD700;
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .input-field {
            flex: 1;
            background: rgba(255, 215, 0, 0.05);
            border: 2px solid #FFD700;
            border-radius: 24px;
            padding: 0.75rem 1rem;
            color: #fff;
            font-size: 0.95rem;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }

        .input-field::placeholder {
            color: rgba(255, 215, 0, 0.6);
        }

        .input-field:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
            color: #000;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .send-btn:active {
            transform: scale(0.9);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .danger-btn {
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid #FF0000;
            color: #FF0000;
        }

        .danger-btn:active {
            background: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        }

        /* MODALES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-radius: 20px;
            padding: 2rem;
            max-width: 90%;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #FFD700;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            color: #FFD700;
        }

        .modal-body {
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.8;
            color: #fff;
        }

        .modal-input {
            width: 100%;
            padding: 0.75rem;
            margin: 1rem 0;
            border-radius: 12px;
            border: 2px solid #FFD700;
            background: rgba(255, 215, 0, 0.05);
            color: #fff;
            font-family: inherit;
            font-size: 1rem;
        }

        .modal-input::placeholder {
            color: rgba(255, 215, 0, 0.6);
        }

        .modal-input:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #FFD700;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FFD700 0%, #FFC700 100%);
            color: #000;
        }

        .modal-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .modal-btn-cancel {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
        }

        .modal-btn-danger {
            background: rgba(255, 0, 0, 0.3);
            color: #FF0000;
            border-color: #FF0000;
        }

        .camera-preview {
            width: 100%;
            border-radius: 12px;
            background: #000;
            margin: 1rem 0;
            border: 2px solid #FFD700;
        }

        .user-info {
            font-size: 0.85rem;
            opacity: 0.9;
            padding: 0.75rem;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 8px;
            word-break: break-all;
            color: #FFD700;
            font-weight: 600;
        }

        .messages-area::-webkit-scrollbar {
            width: 8px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 4px;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: #FFD700;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer">
        <!-- HOME SCREEN -->
        <div class="screen active" id="homeScreen">
            <div class="home-header">
                <div class="home-title">üí¨ ChatP2P</div>
                <div class="home-header-right">
                    <button class="icon-btn" onclick="window.showUserProfile()">üë§</button>
                    <button class="icon-btn" onclick="window.showNewChat()">‚ûï</button>
                </div>
            </div>
            <div class="chats-list" id="chatsList">
                <div class="empty-chats">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üí¨</div>
                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Sin conversaciones</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">Toca el bot√≥n + para crear una nueva</div>
                </div>
            </div>
        </div>

        <!-- USER PROFILE SCREEN -->
        <div class="screen" id="profileScreen">
            <div class="profile-screen">
                <div class="profile-header">
                    <div class="profile-icon">üë§</div>
                    <div class="profile-title">Mi Identidad</div>
                </div>

                <div>
                    <p style="color: #FFD700; font-weight: 700; margin-bottom: 0.5rem;">üìç Mi Wallet</p>
                    <div class="profile-info" id="profileWallet">0x...</div>
                    <button class="profile-btn" onclick="window.copyProfileWallet()">üìã Copiar Wallet</button>
                </div>

                <div>
                    <p style="color: #FFD700; font-weight: 700; margin-bottom: 0.5rem;">üë§ Mi Usuario</p>
                    <div class="profile-info" id="profileUser">anon</div>
                </div>

                <div class="profile-buttons">
                    <button class="profile-btn secondary" onclick="window.showChangeUser()">üîÑ Cambiar Usuario</button>
                    <button class="profile-btn danger" onclick="window.showDeleteUser()">üóëÔ∏è Borrar Todo</button>
                    <button class="profile-btn secondary" onclick="window.goBackToHome()">‚Üê Volver</button>
                </div>
            </div>
        </div>

        <!-- CHAT SCREEN -->
        <div class="screen" id="chatScreen">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="back-btn" onclick="window.goBackToHome()">‚Üê</button>
                    <div class="chat-header-title" id="chatHeaderTitle">Chat</div>
                </div>
                <button class="icon-btn danger-btn" onclick="window.showClearChat()">üóëÔ∏è</button>
            </div>
            <div class="messages-area" id="messagesArea"></div>
            <div class="input-area">
                <textarea class="input-field" id="messageInput" placeholder="Escribe tu mensaje..." rows="1" onkeypress="window.handleKeyPress(event)"></textarea>
                <button class="send-btn" onclick="window.openCamera('photo')">üì∑</button>
                <button class="send-btn" onclick="window.openCamera('video')">üé•</button>
                <button class="send-btn" onclick="window.sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div class="modal" id="createUserModal">
        <div class="modal-content">
            <div class="modal-header">üë§ Crear Identidad</div>
            <div class="modal-body">
                <p>Tu wallet se ha generado autom√°ticamente:</p>
                <div class="user-info" id="walletGenerated">0x...</div>
                <p style="margin-top: 1rem; color: #FFD700;">Ahora elige un nombre de usuario:</p>
                <input type="text" id="userHandleInput" class="modal-input" placeholder="usuario" maxlength="20">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="window.createUser()">Continuar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newConversationModal">
        <div class="modal-content">
            <div class="modal-header">üí¨ Nueva Conversaci√≥n</div>
            <div class="modal-body">
                <p>Ingresa la wallet del contacto con el que deseas chatear:</p>
                <input type="text" id="contactInput" class="modal-input" placeholder="0x..." autocomplete="off">
                <p id="walletError" style="color: #FF0000; font-size: 0.85rem; margin-top: 0.5rem; display: none; font-weight: 700;"></p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="window.closeModal('newConversationModal')">Cancelar</button>
                <button class="modal-btn" onclick="window.startConversation()">Iniciar Chat</button>
            </div>
        </div>
    </div>

    <div class="modal" id="changeUserModal">
        <div class="modal-content">
            <div class="modal-header">üîÑ Cambiar Usuario</div>
            <div class="modal-body">
                <p>Elige un nuevo nombre de usuario:</p>
                <input type="text" id="newUserHandleInput" class="modal-input" placeholder="nuevo_usuario" maxlength="20">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="window.closeModal('changeUserModal')">Cancelar</button>
                <button class="modal-btn" onclick="window.changeUser()">Cambiar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteUserModal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Borrar Todo</div>
            <div class="modal-body">
                <p style="color: #FF0000; font-weight: 700; margin-bottom: 1rem;">Esta acci√≥n es IRREVERSIBLE</p>
                <p>Se eliminar√° permanentemente:</p>
                <ul style="margin-left: 1.5rem; margin-top: 0.5rem; color: #FF0000; font-weight: 600;">
                    <li>Tu identidad y wallet</li>
                    <li>Todos tus chats</li>
                    <li>Todos tus mensajes</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="window.closeModal('deleteUserModal')">Cancelar</button>
                <button class="modal-btn modal-btn-danger" onclick="window.deleteUser()">S√≠, Borrar Todo</button>
            </div>
        </div>
    </div>

    <div class="modal" id="clearChatModal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Eliminar Chat</div>
            <div class="modal-body">
                <p style="color: #FF0000; font-weight: 700;">Se eliminar√°n todos los mensajes en 2 segundos...</p>
                <p style="margin-top: 1rem; opacity: 0.8;">Esta acci√≥n se sincronizar√° en todos los dispositivos.</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="window.closeModal('clearChatModal')">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <div class="modal-header">üì∑ C√°mara Segura</div>
            <div class="modal-body">
                <video id="cameraVideo" class="camera-preview" autoplay playsinline muted></video>
                <canvas id="cameraCanvas" style="display:none;"></canvas>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="window.closeCamera()">Cancelar</button>
                <button class="modal-btn" id="captureBtn" onclick="window.captureMedia()">Capturar</button>
            </div>
        </div>
    </div>

    <script>
        // Prevenir capturas de pantalla
        document.addEventListener('keyup', function(event) {
            if (event.key === 'PrintScreen' || event.keyCode === 44) {
                event.preventDefault();
                alert('Las capturas de pantalla est√°n deshabilitadas por seguridad');
            }
        }, true);

        // Prevenir grabaciones de pantalla
        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
            const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;
            navigator.mediaDevices.getDisplayMedia = function() {
                alert('La grabaci√≥n de pantalla est√° deshabilitada por seguridad');
                return Promise.reject();
            };
        }

        // Prevenir longpress de screenshots
        document.addEventListener('contextmenu', function(event) {
            if (event.srcElement.tagName === 'BODY') {
                event.preventDefault();
            }
        }, false);

        document.addEventListener('DOMContentLoaded', function() {
            // Generar wallet
            function generateWalletAddress() {
                const array = new Uint8Array(20);
                crypto.getRandomValues(array);
                return '0x' + Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // Variables globales
            let walletAddress = localStorage.getItem('walletAddress') || generateWalletAddress();
            localStorage.setItem('walletAddress', walletAddress);
            
            let userHandle = localStorage.getItem('userHandle');
            let currentContact = null;
            let mediaStream = null;
            let isVideo = false;
            let chatsData = JSON.parse(localStorage.getItem('chatsData') || '{}');
            let messagesCache = {};

            // Firebase config - se carga de archivo externo (no hardcodear aqu√≠)
            let firebaseConfig = {
                apiKey: "",
                authDomain: "p2pchat-1a419.firebaseapp.com",
                databaseURL: "https://p2pchat-1a419-default-rtdb.firebaseio.com",
                projectId: "p2pchat-1a419",
                storageBucket: "p2pchat-1a419.firebasestorage.app",
                messagingSenderId: "929030941906",
                appId: "1:929030941906:web:343291b7a37dc2f4f2110b"
            };

            // Cargar API Key desde archivo de configuraci√≥n
            function loadFirebaseConfig() {
                const script = document.createElement('script');
                script.src = 'firebase-config.js';
                script.onload = function() {
                    // Si existe firebaseConfig desde firebase-config.js, reemplaza la apiKey
                    if (typeof firebaseConfig !== 'undefined' && firebaseConfig.apiKey) {
                        console.log('‚úÖ Configuraci√≥n de Firebase cargada desde archivo externo');
                    }
                };
                script.onerror = function() {
                    console.warn('‚ö†Ô∏è No se encontr√≥ firebase-config.js. Crea una copia de firebase-config.example.js');
                };
                document.head.appendChild(script);
            }

            // Cargar config al inicio
            loadFirebaseConfig();

            // Estado de Firebase
            let firebaseReady = false;
            let firebaseAuthToken = null;

            // Inicializar Firebase an√≥nimamente
            function initFirebase() {
                try {
                    // Obtener token an√≥nimo
                    const url = `https://identitytoolkit.googleapis.com/v1/accounts:signupNewUser?key=${firebaseConfig.apiKey}`;
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ returnSecureToken: true })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.idToken) {
                            firebaseAuthToken = data.idToken;
                            firebaseReady = true;
                            console.log('‚úÖ Firebase autenticado an√≥nimamente');
                        } else {
                            console.log('‚ùå No se pudo autenticar en Firebase');
                            firebaseReady = false;
                        }
                    })
                    .catch(e => {
                        console.log('‚ùå Error Firebase auth:', e.message);
                        firebaseReady = false;
                    });
                } catch (e) {
                    console.log('‚ùå Error init Firebase:', e.message);
                }
            }

            // Inicializar Firebase al cargar
            initFirebase();

            // Mostrar wallet en pantalla de perfil
            if (document.getElementById('walletGenerated')) {
                document.getElementById('walletGenerated').textContent = walletAddress;
            }
            if (document.getElementById('profileWallet')) {
                document.getElementById('profileWallet').textContent = walletAddress;
            }

            // Mostrar modal de crear usuario si no existe
            if (!userHandle && document.getElementById('createUserModal')) {
                document.getElementById('createUserModal').classList.add('active');
            } else {
                updateProfileDisplay();
                loadChatsList();
            }

            function updateProfileDisplay() {
                const profileUser = document.getElementById('profileUser');
                if (profileUser) profileUser.textContent = userHandle || 'anon';
                const profileWallet = document.getElementById('profileWallet');
                if (profileWallet) profileWallet.textContent = walletAddress;
            }

            // Crear usuario
            window.createUser = function() {
                const input = document.getElementById('userHandleInput');
                const handle = (input ? input.value.trim() : '') || 'anon';
                userHandle = handle;
                localStorage.setItem('userHandle', userHandle);
                localStorage.setItem('chatsData', JSON.stringify(chatsData));
                
                window.closeModal('createUserModal');
                updateProfileDisplay();
                loadChatsList();
            };

            // Cargar lista de chats
            function loadChatsList() {
                const list = document.getElementById('chatsList');
                if (!list) return;
                
                if (Object.keys(chatsData).length === 0) {
                    list.innerHTML = `
                        <div class="empty-chats">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üí¨</div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Sin conversaciones</div>
                            <div style="font-size: 0.9rem; opacity: 0.7;">Toca el bot√≥n + para crear una nueva</div>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = '';
                Object.entries(chatsData).forEach(([contact, data]) => {
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.onclick = () => window.openChat(contact);
                    const shortWallet = contact.substring(0, 10) + '...';
                    const messages = messagesCache[contact] || [];
                    const lastMsg = messages.length > 0 
                        ? (messages[messages.length - 1].text || 'Multimedia').substring(0, 50)
                        : 'Sin mensajes';
                    item.innerHTML = `
                        <div class="chat-name">${shortWallet}</div>
                        <div class="chat-preview">${lastMsg}</div>
                    `;
                    list.appendChild(item);
                });
            }

            // Abrir chat
            window.openChat = function(contact) {
                // Limpiar listener anterior si existe
                if (currentContact) {
                    cleanupFirebaseListener(currentContact);
                }
                
                currentContact = contact;
                const title = document.getElementById('chatHeaderTitle');
                if (title) title.textContent = contact.substring(0, 10) + '...';
                
                const homeScreen = document.getElementById('homeScreen');
                const profileScreen = document.getElementById('profileScreen');
                const chatScreen = document.getElementById('chatScreen');
                if (homeScreen) homeScreen.classList.remove('active');
                if (profileScreen) profileScreen.classList.remove('active');
                if (chatScreen) chatScreen.classList.add('active');
                
                // Activar listener de Firebase
                setupFirebaseListener(contact);
                
                loadMessages();
            };

            // Cargar mensajes
            function loadMessages() {
                const area = document.getElementById('messagesArea');
                if (!area || !currentContact) return;
                
                const messages = messagesCache[currentContact] || [];
                area.innerHTML = '';
                
                messages.forEach(msg => {
                    if (!msg) return;
                    const msgEl = document.createElement('div');
                    msgEl.className = `message ${msg.from === walletAddress ? 'own' : 'other'}`;
                    
                    if (msg.text) {
                        if (msg.text.startsWith('data:image') || msg.text.startsWith('data:video')) {
                            msgEl.innerHTML = `
                                <div>
                                    ${msg.text.startsWith('data:image') ? `<img src="${msg.text}">` : `<video src="${msg.text}" controls></video>`}
                                </div>
                            `;
                        } else {
                            msgEl.innerHTML = `<div class="message-bubble">${escapeHtml(msg.text)}</div>`;
                        }
                        area.appendChild(msgEl);
                    }
                });
                
                area.scrollTop = area.scrollHeight;
            }

            // Escapar HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Enviar mensaje
            window.sendMessage = function() {
                const input = document.getElementById('messageInput');
                const text = input ? input.value.trim() : '';
                
                if (!text || !currentContact) return;
                
                if (!messagesCache[currentContact]) {
                    messagesCache[currentContact] = [];
                }
                
                const msg = {
                    from: walletAddress,
                    text: text,
                    timestamp: Date.now(),
                    handle: userHandle
                };
                
                messagesCache[currentContact].push(msg);
                localStorage.setItem(`messages_${currentContact}`, JSON.stringify(messagesCache[currentContact]));
                
                // Enviar a Firebase si est√° disponible
                sendToFirebase(currentContact, msg);
                
                if (input) input.value = '';
                loadMessages();
            };

            // Enviar a Firebase
            function sendToFirebase(contact, message) {
                if (!firebaseReady) {
                    console.log('‚è≥ Firebase no listo, reintentando en 2 seg...');
                    setTimeout(() => sendToFirebase(contact, message), 2000);
                    return;
                }

                try {
                    const roomId = [walletAddress, contact].sort().join('_');
                    const url = `${firebaseConfig.databaseURL}/chats/${roomId}/messages.json?auth=${firebaseAuthToken}`;
                    
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...message,
                            sent: true
                        })
                    })
                    .then(res => {
                        if (res.ok) {
                            console.log('‚úÖ Mensaje enviado a Firebase:', roomId);
                            return res.json();
                        } else {
                            console.log('‚ùå Error enviando (status ' + res.status + '):', roomId);
                            throw new Error('HTTP ' + res.status);
                        }
                    })
                    .then(data => {
                        console.log('üìç Mensaje guardado con ID:', data.name);
                    })
                    .catch(e => {
                        console.log('‚ùå Error Firebase:', e.message);
                    });
                } catch (e) {
                    console.log('‚ùå Error:', e.message);
                }
            }

            // Cargar mensajes de Firebase en tiempo real
            function setupFirebaseListener(contact) {
                if (!firebaseReady) {
                    console.log('‚è≥ Firebase no listo, reintentando listener en 2 seg...');
                    setTimeout(() => setupFirebaseListener(contact), 2000);
                    return;
                }

                try {
                    const roomId = [walletAddress, contact].sort().join('_');
                    const url = `${firebaseConfig.databaseURL}/chats/${roomId}/messages.json?auth=${firebaseAuthToken}`;
                    
                    console.log('üîó Conectando a Firebase:', roomId);
                    
                    // Escuchar cambios cada 1.5 segundos (m√°s r√°pido)
                    const listener = setInterval(() => {
                        if (!firebaseReady) return;
                        
                        fetch(url)
                            .then(res => {
                                if (!res.ok) throw new Error('HTTP ' + res.status);
                                return res.json();
                            })
                            .then(data => {
                                if (!data || typeof data !== 'object') return;
                                
                                // Convertir objeto a array
                                const firebaseMessages = Object.entries(data)
                                    .map(([key, msg]) => ({
                                        ...msg,
                                        firebaseId: key
                                    }))
                                    .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                                
                                // Comparar con local y agregar nuevos
                                if (!messagesCache[contact]) {
                                    messagesCache[contact] = [];
                                }
                                
                                const localIds = new Set(
                                    messagesCache[contact].map(m => m.firebaseId)
                                );
                                
                                let hasNew = false;
                                let newCount = 0;
                                
                                firebaseMessages.forEach(fbMsg => {
                                    if (!localIds.has(fbMsg.firebaseId)) {
                                        messagesCache[contact].push(fbMsg);
                                        hasNew = true;
                                        newCount++;
                                    }
                                });
                                
                                // Log si hay nuevos
                                if (newCount > 0) {
                                    console.log('üì® ' + newCount + ' nuevo(s) mensaje(s) de Firebase');
                                }
                                
                                // Actualizar vista si hay nuevos y estamos en este chat
                                if (hasNew && currentContact === contact) {
                                    localStorage.setItem(
                                        `messages_${contact}`, 
                                        JSON.stringify(messagesCache[contact])
                                    );
                                    loadMessages();
                                }
                            })
                            .catch(e => {
                                // Error silencioso - puede ser red o Firebase
                            });
                    }, 1500);
                    
                    // Guardar listener para limpiar despu√©s
                    if (!window.firebaseListeners) {
                        window.firebaseListeners = {};
                    }
                    window.firebaseListeners[contact] = listener;
                    
                    console.log('üëÇ Listener activado para:', contact);
                } catch (e) {
                    console.log('‚ùå Error setup listener:', e.message);
                }
            }

            // Limpiar listener
            function cleanupFirebaseListener(contact) {
                if (window.firebaseListeners && window.firebaseListeners[contact]) {
                    clearInterval(window.firebaseListeners[contact]);
                    delete window.firebaseListeners[contact];
                    console.log('üîå Listener limpiado para:', contact);
                }
            }

            // Eliminar todo chat en segundos
            window.showClearChat = function() {
                const modal = document.getElementById('clearChatModal');
                if (modal) modal.classList.add('active');
                
                setTimeout(() => {
                    window.closeModal('clearChatModal');
                    clearChatPermanent();
                }, 2000);
            };

            function clearChatPermanent() {
                if (!currentContact) return;
                
                // Limpiar localmente
                messagesCache[currentContact] = [];
                localStorage.removeItem(`messages_${currentContact}`);
                chatsData[currentContact] = { lastMessage: '', lastMessageTime: 0 };
                localStorage.setItem('chatsData', JSON.stringify(chatsData));
                
                // Limpiar en Firebase
                try {
                    const roomId = [walletAddress, currentContact].sort().join('_');
                    const url = `${firebaseConfig.databaseURL}/chats/${roomId}/messages.json`;
                    fetch(url, { method: 'DELETE' }).catch(() => {});
                } catch (e) {}
                
                window.goBackToHome();
            }

            // Iniciar conversaci√≥n
            window.startConversation = function() {
                const input = document.getElementById('contactInput');
                const errorEl = document.getElementById('walletError');
                const contact = input ? input.value.trim() : '';
                
                if (!contact.startsWith('0x')) {
                    if (errorEl) {
                        errorEl.textContent = '‚ö†Ô∏è Debe comenzar con 0x';
                        errorEl.style.display = 'block';
                    }
                    return;
                }
                
                if (contact === walletAddress) {
                    if (errorEl) {
                        errorEl.textContent = '‚ö†Ô∏è No puedes chatear contigo mismo';
                        errorEl.style.display = 'block';
                    }
                    return;
                }
                
                if (chatsData[contact]) {
                    if (errorEl) {
                        errorEl.textContent = '‚ö†Ô∏è Ya existe conversaci√≥n con este contacto';
                        errorEl.style.display = 'block';
                    }
                    return;
                }
                
                chatsData[contact] = { lastMessage: '', lastMessageTime: 0 };
                messagesCache[contact] = [];
                localStorage.setItem('chatsData', JSON.stringify(chatsData));
                
                if (input) input.value = '';
                if (errorEl) errorEl.style.display = 'none';
                window.closeModal('newConversationModal');
                loadChatsList();
                window.openChat(contact);
            };

            // C√°mara
            window.openCamera = function(type) {
                isVideo = type === 'video';
                const modal = document.getElementById('cameraModal');
                if (modal) modal.classList.add('active');
                
                navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: isVideo
                }).then(stream => {
                    mediaStream = stream;
                    const video = document.getElementById('cameraVideo');
                    if (video) video.srcObject = stream;
                    const btn = document.getElementById('captureBtn');
                    if (btn) btn.textContent = isVideo ? 'üé• Grabar' : 'üì∑ Capturar';
                }).catch(() => {
                    alert('No se pudo acceder a la c√°mara');
                    window.closeCamera();
                });
            };

            window.captureMedia = function() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.getElementById('cameraCanvas');
                if (!video || !canvas) return;
                
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.7);
                
                if (!messagesCache[currentContact]) {
                    messagesCache[currentContact] = [];
                }
                
                const msg = {
                    from: walletAddress,
                    text: imageData,
                    timestamp: Date.now(),
                    handle: userHandle
                };
                
                messagesCache[currentContact].push(msg);
                localStorage.setItem(`messages_${currentContact}`, JSON.stringify(messagesCache[currentContact]));
                sendToFirebase(currentContact, msg);
                
                window.closeCamera();
                loadMessages();
            };

            window.closeCamera = function() {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                const modal = document.getElementById('cameraModal');
                if (modal) modal.classList.remove('active');
            };

            // Navegaci√≥n
            window.goBackToHome = function() {
                // Limpiar listener anterior
                if (currentContact) {
                    cleanupFirebaseListener(currentContact);
                }
                
                const homeScreen = document.getElementById('homeScreen');
                const chatScreen = document.getElementById('chatScreen');
                const profileScreen = document.getElementById('profileScreen');
                if (chatScreen) chatScreen.classList.remove('active');
                if (profileScreen) profileScreen.classList.remove('active');
                if (homeScreen) homeScreen.classList.add('active');
                currentContact = null;
                loadChatsList();
            };

            window.showUserProfile = function() {
                const homeScreen = document.getElementById('homeScreen');
                const profileScreen = document.getElementById('profileScreen');
                if (homeScreen) homeScreen.classList.remove('active');
                if (profileScreen) profileScreen.classList.add('active');
                updateProfileDisplay();
            };

            window.showNewChat = function() {
                const modal = document.getElementById('newConversationModal');
                if (modal) modal.classList.add('active');
            };

            window.showChangeUser = function() {
                const modal = document.getElementById('changeUserModal');
                if (modal) modal.classList.add('active');
            };

            window.changeUser = function() {
                const input = document.getElementById('newUserHandleInput');
                const newHandle = (input ? input.value.trim() : '') || 'anon';
                userHandle = newHandle;
                localStorage.setItem('userHandle', userHandle);
                
                window.closeModal('changeUserModal');
                updateProfileDisplay();
            };

            window.copyProfileWallet = function() {
                navigator.clipboard.writeText(walletAddress).then(() => {
                    alert('‚úÖ Wallet copiada');
                }).catch(() => {
                    alert('Error al copiar');
                });
            };

            window.showDeleteUser = function() {
                const modal = document.getElementById('deleteUserModal');
                if (modal) modal.classList.add('active');
            };

            window.deleteUser = function() {
                localStorage.clear();
                location.reload();
            };

            window.closeModal = function(id) {
                const modal = document.getElementById(id);
                if (modal) modal.classList.remove('active');
            };

            window.handleKeyPress = function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    window.sendMessage();
                }
            };

            // Cargar mensajes guardados
            Object.keys(chatsData).forEach(contact => {
                const saved = localStorage.getItem(`messages_${contact}`);
                if (saved) {
                    messagesCache[contact] = JSON.parse(saved);
                }
            });
        });
    </script>
</body>
</html>
